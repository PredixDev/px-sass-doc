<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. tests, examples), we assume the server is started with
    'gulp serve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
-->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="css/px-sass-doc-viewer-styles.html">

<!--
Element that accepts a block of code in its light DOM, requests that code be
highlighted, then places it in a targeted node. Requires the prism-highlighter
element to be somewhere in the DOM to handle highlighting events.

##### Usage

      <px-highlighter
        highlight-target="#targetID"
        raw-target="#otherTargetID">
          <section data-highlight="true">
            ... code in here ...
          </section>
      </px-highlighter>

@element px-highlighter
@blurb Element that highlights a block of code and puts it into a targeted node.
-->

<dom-module id="px-highlighter">
  <template>
    <style include="px-sass-doc-viewer-styles"></style>
    <section style="display:none;">
      <content></content>
    </section>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-highlighter',

    /**
     * Properties block, expose attribute values to the DOM via 'notify'
     *
     * @property properties
     * @type Object
     */
    properties: {
      /**
      * The ID of the node in our parent we want to put the highlighted code into.
      *
      * @property highlightTarget
      * @type String
      **/
      highlightTarget: {
        type: String,
        value: ''
      },
      /**
      * The ID of the node in our parent we want to put the raw code into (through innerHTML).
      *
      * @property rawTarget
      * @type String
      */
      rawTarget: {
        type: String,
        value: ''
      },
      /**
      * PRIVATE. Holds the highlighted code after it goes through prism.
      *
      * @property _highlightCode
      * @type String
      */
      _highlightCode: {
        type: String,
        value: ''
      },
      /**
      * PRIVATE. Holds the raw code from the light DOM.
      *
      * @property _rawCode
      * @type String
      */
      _rawCode: {
        type: String,
        value: ''
      }
    },
    observers: [
      '_render(_highlightCode,highlightTarget)',
      '_render(_rawCode,rawTarget)'
    ],
    ready: function() {
      var observer = new MutationObserver(function(mutations) {
        // Go highlight myself.
        this._highlight();
      }.bind(this))
      observer.observe(this, {
        characterData: true,
        attributes: true,
        subtree: true,
        attributeOldValue: true,
      });
    },
    /**
    * Renders the raw or highlighted code into the DOM of this parent's element
    * by targeted requested IDs.
    *
    * @method _render
    */
    _render: function(str,target) {
      if (str && target) {
        this.domHost.$$(target).innerHTML = str;
      }
    },
    /**
    * This method finds code the light DOM and sends it for highlighting. It puts
    * the raw code and resulting highlighted code into internal representations
    * to be placed into the document.
    *
    * @method _highlight
    */
    _highlight: function() {
      var code = this.getContentChildren()[0].innerHTML,
          output = this._fireOutputEvent(code).replace(/[\r\n]+/g, '\n').trim();
      if (output.indexOf('class="token') < 0) {
        // Prism highlighter hasn't loaded yet. Run this again with async.
        this.async(this._highlight,50);
      } else {
        this._rawCode = code;
        this._highlightCode = output;
      }
    },
    /**
    * This method fires a syntax-highlight event (meant for prism-highlighter), and returns the code, with formatting.
    *
    * @method _fireOutputEvent
    * @return {Highlighted Code}
    */
    _fireOutputEvent: function(code, lang) {
      return this.domHost.fire('syntax-highlight', {code: code, lang: lang}).detail.code;
    }
  });
</script>
